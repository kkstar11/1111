<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>发布/编辑商品 - 二手交易平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .upload-box {
            width: 100%;
            height: 200px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }
        
        .upload-box:hover {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }
        
        .upload-box.drag-over {
            border-color: #0d6efd;
            background-color: #e7f1ff;
            border-style: solid;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #6c757d;
            line-height: 1;
            margin-bottom: 10px;
        }
        
        .upload-text {
            color: #6c757d;
            font-size: 14px;
        }
        
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .image-preview-item {
            position: relative;
            width: 120px;
            height: 120px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background-color: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
            padding: 0;
        }
        
        .image-preview-item .remove-btn:hover {
            background-color: rgba(220, 53, 69, 1);
        }
        /* Navigation hover effects */
        .navbar-nav .nav-item .nav-link {
            position: relative;
            padding: 8px 16px;
            margin: 0 4px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        .navbar-nav .nav-item .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .navbar-nav .nav-item .nav-link.active {
            background-color: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation Bar -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">二手交易平台</a>
            <ul class="navbar-nav ms-auto d-flex flex-row gap-2">
                <li class="nav-item">
                    <a class="nav-link" href="/">首页</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/item-edit.html">发布商品</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/user-center.html">个人中心</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4 mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-body p-4">
                        <h2 class="card-title mb-4" th:text="${item != null} ? '编辑商品' : '发布商品'">发布商品</h2>
                        
                        <div class="alert alert-danger" id="errorAlert" style="display: none;"></div>
                        <div class="alert alert-success" id="successAlert" style="display: none;"></div>
                        
                        <form id="itemForm" method="post" action="/item-edit.html">
                            <input type="hidden" id="itemId" name="id" th:value="${item?.id}" />
                            
                            <div class="mb-3">
                                <label for="title" class="form-label">商品标题 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" name="name"
                                       th:value="${item?.name}"
                                       placeholder="请输入商品标题" required maxlength="100" />
                            </div>
                            
                            <div class="mb-3">
                                <label for="category" class="form-label">商品分类 <span class="text-danger">*</span></label>
                                <select class="form-select" id="category" name="category" required>
                                    <option value="">请选择分类</option>
                                    <option value="电子产品" th:selected="${item?.category == '电子产品'}">电子产品</option>
                                    <option value="图书教材" th:selected="${item?.category == '图书教材'}">图书教材</option>
                                    <option value="生活用品" th:selected="${item?.category == '生活用品'}">生活用品</option>
                                    <option value="服装鞋帽" th:selected="${item?.category == '服装鞋帽'}">服装鞋帽</option>
                                    <option value="运动器材" th:selected="${item?.category == '运动器材'}">运动器材</option>
                                    <option value="其他" th:selected="${item?.category == '其他'}">其他</option>
                                </select>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="price" class="form-label">售价 <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text">¥</span>
                                        <input type="number" class="form-control" id="price" name="price" 
                                               th:value="${item?.price}"
                                               placeholder="0.00" step="0.01" min="0" required />
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="originalPrice" class="form-label">原价</label>
                                    <div class="input-group">
                                        <span class="input-group-text">¥</span>
                                        <input type="number" class="form-control" id="originalPrice" name="originalPrice" 
                                               th:value="${item?.originalPrice}"
                                               placeholder="0.00" step="0.01" min="0" />
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="conditions" class="form-label">商品成色 <span class="text-danger">*</span></label>
                                <select class="form-select" id="conditions" name="conditions" required>
                                    <option value="">请选择成色</option>
                                    <option value="1" th:selected="${item?.conditions == 1}">全新</option>
                                    <option value="2" th:selected="${item?.conditions == 2}">良好</option>
                                    <option value="3" th:selected="${item?.conditions == 3}">一般</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="description" class="form-label">商品描述 <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="description" name="description" 
                                          rows="5" placeholder="请详细描述商品的情况、购买时间、使用情况等" 
                                          required maxlength="2000" th:text="${item?.description}"></textarea>
                                <div class="form-text">详细的描述可以提高成交率</div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="location" class="form-label">交易地点</label>
                                    <input type="text" class="form-control" id="location" name="location" 
                                           th:value="${item?.location}"
                                           placeholder="例如：北京市海淀区" />
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="contactWay" class="form-label">联系方式</label>
                                    <input type="text" class="form-control" id="contactWay" name="contactWay" 
                                           th:value="${item?.contactWay}"
                                           placeholder="例如：微信号、QQ号" />
                                </div>
                            </div>
                            
                            <!-- Image Upload Section -->
                            <div class="mb-3">
                                <label class="form-label">商品图片</label>
                                <input type="hidden" id="imageUrls" name="imageUrls" th:value="${item?.imageUrls}" />
                                
                                <!-- Upload Box -->
                                <div id="uploadBox" class="upload-box">
                                    <div class="upload-icon">+</div>
                                    <div class="upload-text">点击或拖拽上传图片</div>
                                    <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" />
                                </div>
                                
                                <!-- Image Preview Area -->
                                <div id="imagePreviewContainer" class="image-preview-container"></div>
                            </div>
                            
                            <div class="mb-3" th:if="${item != null}">
                                <label for="status" class="form-label">商品状态</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="1" th:selected="${item?.status == 1}">上架</option>
                                    <option value="2" th:selected="${item?.status == 2}">下架</option>
                                    <option value="3" th:selected="${item?.status == 3}">已售出</option>
                                </select>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" th:text="${item != null} ? '保存修改' : '发布商品'">发布商品</button>
                                <a href="/" class="btn btn-outline-secondary">取消</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Image upload and preview handling
        let selectedImages = [];
        
        $(document).ready(function() {
            // Click event for upload box
            $('#uploadBox').click(function() {
                $('#imageInput').click();
            });
            
            // File input change event
            $('#imageInput').change(function(e) {
                handleFiles(e.target.files);
            });
            
            // Drag and drop events
            let dragCounter = 0;
            
            $('#uploadBox').on('dragenter', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dragCounter++;
                $(this).addClass('drag-over');
            });
            
            $('#uploadBox').on('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
            });
            
            $('#uploadBox').on('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dragCounter--;
                if (dragCounter === 0) {
                    $(this).removeClass('drag-over');
                }
            });
            
            $('#uploadBox').on('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dragCounter = 0;
                $(this).removeClass('drag-over');
                
                const files = e.originalEvent.dataTransfer.files;
                handleFiles(files);
            });
            
            // Load existing images if editing
            const existingImageUrls = $('#imageUrls').val();
            if (existingImageUrls) {
                const urls = existingImageUrls.split(',').filter(url => url.trim());
                urls.forEach(function(url) {
                    addImagePreviewFromUrl(url.trim());
                });
            }
        });
        
        function handleFiles(files) {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Validate file type
                if (!file.type.match('image.*')) {
                    $('#errorAlert').text('请选择图片文件！').show();
                    setTimeout(function() { $('#errorAlert').hide(); }, 3000);
                    continue;
                }
                
                // Store file reference and capture index
                const currentIndex = selectedImages.length;
                selectedImages.push(file);
                
                // Create preview
                const reader = new FileReader();
                reader.onload = (function(index) {
                    return function(e) {
                        addImagePreview(e.target.result, index);
                    };
                })(currentIndex);
                reader.readAsDataURL(file);
            }
        }
        
        function addImagePreview(src, index) {
            const previewDiv = $('<div></div>')
                .addClass('image-preview-item')
                .attr('data-index', index);
            
            const img = $('<img>')
                .attr('src', src)
                .attr('alt', '预览图片');
            
            const removeBtn = $('<button></button>')
                .attr('type', 'button')
                .addClass('remove-btn')
                .text('×')
                .on('click', function() {
                    removeImage(index);
                });
            
            previewDiv.append(img).append(removeBtn);
            $('#imagePreviewContainer').append(previewDiv);
        }
        
        function addImagePreviewFromUrl(url) {
            const previewDiv = $('<div></div>')
                .addClass('image-preview-item')
                .attr('data-url', url);
            
            const img = $('<img>')
                .attr('src', url)
                .attr('alt', '预览图片');
            
            const removeBtn = $('<button></button>')
                .attr('type', 'button')
                .addClass('remove-btn')
                .text('×')
                .on('click', function() {
                    removeImageByUrl(url);
                });
            
            previewDiv.append(img).append(removeBtn);
            $('#imagePreviewContainer').append(previewDiv);
        }
        
        function removeImage(index) {
            // Remove from array
            selectedImages.splice(index, 1);
            
            // Remove preview element
            $('.image-preview-item[data-index]').filter(function() {
                return parseInt($(this).attr('data-index')) === index;
            }).remove();
            
            // Update remaining indices and re-bind click handlers
            $('.image-preview-item[data-index]').each(function() {
                const currentIndex = parseInt($(this).attr('data-index'));
                if (currentIndex > index) {
                    const newIndex = currentIndex - 1;
                    $(this).attr('data-index', newIndex);
                    // Re-bind the click handler with new index
                    $(this).find('.remove-btn').off('click').on('click', function() {
                        removeImage(newIndex);
                    });
                }
            });
        }
        
        function removeImageByUrl(url) {
            $('.image-preview-item[data-url]').filter(function() {
                return $(this).attr('data-url') === url;
            }).remove();
            updateImageUrlsField();
        }
        
        function updateImageUrlsField() {
            const existingUrls = [];
            $('.image-preview-item[data-url]').each(function() {
                existingUrls.push($(this).attr('data-url'));
            });
            $('#imageUrls').val(existingUrls.join(','));
        }
        
        $('#itemForm').submit(function(e) {
            e.preventDefault();
            
            // Update imageUrls field from existing URL previews
            updateImageUrlsField();
            
            // Clear previous alerts
            $('#errorAlert, #successAlert').hide();
            
            const itemId = $('#itemId').val();
            const isEdit = itemId && itemId.length > 0;
            
            const formData = {
                name: $('#title').val(),
                description: $('#description').val(),
                price: parseFloat($('#price').val()),
                originalPrice: $('#originalPrice').val() ? parseFloat($('#originalPrice').val()) : null,
                category: $('#category').val(),
                conditions: parseInt($('#conditions').val()),
                location: $('#location').val(),
                contactWay: $('#contactWay').val(),
                imageUrls: $('#imageUrls').val()
            };
            console.log('formData', formData);
            // Include status if editing
            if (isEdit && $('#status').length) {
                formData.status = parseInt($('#status').val());
            }
            
            const url = isEdit ? '/api/items/' + itemId : '/api/items';
            const method = isEdit ? 'PUT' : 'POST';
            
            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        $('#successAlert').text(isEdit ? '商品更新成功！' : '商品发布成功！').show();
                        setTimeout(function() {
                            window.location.href = '/';
                        }, 1500);
                    } else {
                        $('#errorAlert').text(response.message || '操作失败').show();
                    }
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        alert('请先登录');
                        window.location.href = '/login.html';
                    } else {
                        const response = xhr.responseJSON;
                        $('#errorAlert').text(response?.message || '操作失败，请稍后重试').show();
                    }
                }
            });
        });
    </script>
</body>
</html>
