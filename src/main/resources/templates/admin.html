<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜åå° - é—²é±¼äºŒæ‰‹äº¤æ˜“å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        .header {
            background-color: #ff6600;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 1.5rem;
        }
        .header .logout-btn {
            background-color: white;
            color: #ff6600;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .header .logout-btn:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        .section {
            background-color: white;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #ff6600;
            border-bottom: 2px solid #ff6600;
            padding-bottom: 0.5rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background-color: #f9f9f9;
            font-weight: 600;
            color: #555;
        }
        tr:hover {
            background-color: #fafafa;
        }
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
            transition: all 0.3s;
        }
        .btn-enable {
            background-color: #4CAF50;
            color: white;
        }
        .btn-enable:hover {
            background-color: #45a049;
        }
        .btn-disable {
            background-color: #f44336;
            color: white;
        }
        .btn-disable:hover {
            background-color: #da190b;
        }
        .btn-approve {
            background-color: #2196F3;
            color: white;
        }
        .btn-approve:hover {
            background-color: #0b7dda;
        }
        .btn-reject {
            background-color: #ff9800;
            color: white;
        }
        .btn-reject:hover {
            background-color: #e68900;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-active {
            background-color: #e8f5e9;
            color: #4caf50;
        }
        .badge-disabled {
            background-color: #ffebee;
            color: #f44336;
        }
        .badge-pending {
            background-color: #fff3e0;
            color: #ff9800;
        }
        .badge-admin {
            background-color: #e3f2fd;
            color: #2196f3;
        }
        .badge-user {
            background-color: #f5f5f5;
            color: #666;
        }
        .empty-message {
            text-align: center;
            padding: 3rem;
            color: #999;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ›¡ï¸ ç®¡ç†å‘˜åå°</h1>
        <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>

    <div class="container">
        <!-- ç”¨æˆ·ç®¡ç†åŒºåŸŸ -->
        <div class="section">
            <h2 class="section-title">ğŸ‘¥ ç”¨æˆ·è´¦å·ç®¡ç†</h2>
            <div id="userLoading" class="loading">åŠ è½½ä¸­...</div>
            <div id="userContent" style="display: none;">
                <table id="userTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ç”¨æˆ·å</th>
                            <th>å­¦å·</th>
                            <th>é‚®ç®±</th>
                            <th>è§’è‰²</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                    </tbody>
                </table>
            </div>
            <div id="userEmpty" class="empty-message" style="display: none;">
                æš‚æ— ç”¨æˆ·æ•°æ®
            </div>
        </div>

        <!-- å•†å“å®¡æ ¸åŒºåŸŸ -->
        <div class="section">
            <h2 class="section-title">ğŸ“¦ å¾…å®¡æ ¸å•†å“ç®¡ç†</h2>
            <div id="itemLoading" class="loading">åŠ è½½ä¸­...</div>
            <div id="itemContent" style="display: none;">
                <table id="itemTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>å•†å“åç§°</th>
                            <th>ä»·æ ¼</th>
                            <th>åˆ†ç±»</th>
                            <th>å–å®¶ID</th>
                            <th>å‘å¸ƒæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="itemTableBody">
                    </tbody>
                </table>
            </div>
            <div id="itemEmpty" class="empty-message" style="display: none;">
                æš‚æ— å¾…å®¡æ ¸å•†å“
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
            loadPendingItems();
        });

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                fetch('/api/users/logout', {
                    method: 'POST',
                    credentials: 'include'
                })
                .then(response => response.json())
                .then(result => {
                    alert('é€€å‡ºç™»å½•æˆåŠŸ');
                    window.location.href = '/login.html';
                })
                .catch(error => {
                    console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                    // å³ä½¿å‡ºé”™ä¹Ÿé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                    window.location.href = '/login.html';
                });
            }
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        function loadUsers() {
            fetch('/api/admin/users', {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(result => {
                document.getElementById('userLoading').style.display = 'none';
                if (result.success && result.data && result.data.length > 0) {
                    document.getElementById('userContent').style.display = 'block';
                    renderUserTable(result.data);
                } else {
                    document.getElementById('userEmpty').style.display = 'block';
                }
            })
            .catch(error => {
                document.getElementById('userLoading').style.display = 'none';
                document.getElementById('userEmpty').style.display = 'block';
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                alert('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥ï¼Œè¯·ç¡®ä¿æ‚¨æœ‰ç®¡ç†å‘˜æƒé™');
            });
        }

        // æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼
        function renderUserTable(users) {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';
            users.forEach(user => {
                const tr = document.createElement('tr');
                const roleText = user.role === 1 ? '<span class="badge badge-admin">ç®¡ç†å‘˜</span>' : '<span class="badge badge-user">æ™®é€šç”¨æˆ·</span>';
                const statusText = user.status === 1 ? '<span class="badge badge-active">æ­£å¸¸</span>' : '<span class="badge badge-disabled">ç¦ç”¨</span>';
                const actionBtn = user.status === 1 
                    ? `<button class="btn btn-disable" onclick="updateUserStatus(${user.id}, 0)">ç¦ç”¨</button>`
                    : `<button class="btn btn-enable" onclick="updateUserStatus(${user.id}, 1)">å¯ç”¨</button>`;
                
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username || '-'}</td>
                    <td>${user.studentId || '-'}</td>
                    <td>${user.email || '-'}</td>
                    <td>${roleText}</td>
                    <td>${statusText}</td>
                    <td>${actionBtn}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // æ›´æ–°ç”¨æˆ·çŠ¶æ€
        function updateUserStatus(userId, status) {
            const action = status === 1 ? 'å¯ç”¨' : 'ç¦ç”¨';
            if (!confirm(`ç¡®å®šè¦${action}è¯¥ç”¨æˆ·å—ï¼Ÿ`)) {
                return;
            }

            fetch(`/api/admin/users/${userId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ status: status })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(`${action}æˆåŠŸï¼`);
                    loadUsers(); // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                } else {
                    alert(`${action}å¤±è´¥: ${result.message}`);
                }
            })
            .catch(error => {
                console.error('æ›´æ–°ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error);
                alert(`${action}å¤±è´¥ï¼Œè¯·é‡è¯•`);
            });
        }

        // åŠ è½½å¾…å®¡æ ¸å•†å“åˆ—è¡¨
        function loadPendingItems() {
            fetch('/api/admin/items/pending', {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(result => {
                document.getElementById('itemLoading').style.display = 'none';
                if (result.success && result.data && result.data.length > 0) {
                    document.getElementById('itemContent').style.display = 'block';
                    renderItemTable(result.data);
                } else {
                    document.getElementById('itemEmpty').style.display = 'block';
                }
            })
            .catch(error => {
                document.getElementById('itemLoading').style.display = 'none';
                document.getElementById('itemEmpty').style.display = 'block';
                console.error('åŠ è½½å¾…å®¡æ ¸å•†å“å¤±è´¥:', error);
                alert('åŠ è½½å¾…å®¡æ ¸å•†å“å¤±è´¥ï¼Œè¯·ç¡®ä¿æ‚¨æœ‰ç®¡ç†å‘˜æƒé™');
            });
        }

        // æ¸²æŸ“å•†å“è¡¨æ ¼
        function renderItemTable(items) {
            const tbody = document.getElementById('itemTableBody');
            tbody.innerHTML = '';
            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.name || '-'}</td>
                    <td>Â¥${item.price || 0}</td>
                    <td>${item.category || '-'}</td>
                    <td>${item.ownerId || '-'}</td>
                    <td>-</td>
                    <td>
                        <button class="btn btn-approve" onclick="approveItem(${item.id})">é€šè¿‡</button>
                        <button class="btn btn-reject" onclick="rejectItem(${item.id})">é©³å›</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // å®¡æ ¸é€šè¿‡å•†å“
        function approveItem(itemId) {
            if (!confirm('ç¡®å®šè¦é€šè¿‡è¯¥å•†å“çš„å®¡æ ¸å—ï¼Ÿ')) {
                return;
            }

            fetch(`/api/admin/items/${itemId}/approve`, {
                method: 'PUT',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('å®¡æ ¸é€šè¿‡ï¼');
                    loadPendingItems(); // é‡æ–°åŠ è½½å¾…å®¡æ ¸å•†å“åˆ—è¡¨
                } else {
                    alert(`å®¡æ ¸å¤±è´¥: ${result.message}`);
                }
            })
            .catch(error => {
                console.error('å®¡æ ¸å•†å“å¤±è´¥:', error);
                alert('å®¡æ ¸å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        // é©³å›å•†å“
        function rejectItem(itemId) {
            if (!confirm('ç¡®å®šè¦é©³å›è¯¥å•†å“å—ï¼Ÿ')) {
                return;
            }

            fetch(`/api/admin/items/${itemId}/reject`, {
                method: 'PUT',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('å•†å“å·²é©³å›ï¼');
                    loadPendingItems(); // é‡æ–°åŠ è½½å¾…å®¡æ ¸å•†å“åˆ—è¡¨
                } else {
                    alert(`é©³å›å¤±è´¥: ${result.message}`);
                }
            })
            .catch(error => {
                console.error('é©³å›å•†å“å¤±è´¥:', error);
                alert('é©³å›å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }
    </script>
</body>
</html>
