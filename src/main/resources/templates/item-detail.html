<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${item?.title} + ' - 商品详情'">商品详情</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .main-image {
            max-height: 500px;
            object-fit: contain;
            width: 100%;
        }
        .thumbnail {
            height: 80px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .thumbnail:hover, .thumbnail.active {
            border-color: #0d6efd;
        }
        .price {
            color: #ff4d4f;
            font-size: 2rem;
            font-weight: bold;
        }
        .original-price {
            color: #999;
            text-decoration: line-through;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">二手交易平台</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/item-edit.html">发布商品</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/my-orders.html">我的订单</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/user-center.html">个人中心</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/login.html">登录</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <!-- Product Images -->
            <div class="col-md-6">
                <div class="mb-3">
                    <img id="mainImage" 
                         th:src="${item.imageUrls != null and !#strings.isEmpty(item.imageUrls)} ? ${#strings.listSplit(item.imageUrls, ',')[0]} : 'https://via.placeholder.com/500x500?text=No+Image'" 
                         class="main-image border rounded" 
                         th:alt="${item.title}" />
                </div>
                <div class="d-flex gap-2" th:if="${item.imageUrls != null and !#strings.isEmpty(item.imageUrls)}">
                    <img th:each="imageUrl, iterStat : ${#strings.listSplit(item.imageUrls, ',')}" 
                         th:src="${imageUrl}" 
                         th:class="${iterStat.index == 0} ? 'thumbnail active' : 'thumbnail'" 
                         class="thumbnail rounded"
                         th:alt="'商品图片 ' + ${iterStat.index + 1}"
                         onclick="changeMainImage(this.src)" />
                </div>
            </div>

            <!-- Product Info -->
            <div class="col-md-6">
                <h2 th:text="${item.title}">商品标题</h2>
                
                <div class="mb-3">
                    <span class="badge bg-info" th:text="${item.category}">分类</span>
                    <span class="badge bg-success" th:if="${item.itemCondition == 1}">全新</span>
                    <span class="badge bg-primary" th:if="${item.itemCondition == 2}">良好</span>
                    <span class="badge bg-secondary" th:if="${item.itemCondition == 3}">一般</span>
                    <span class="badge bg-success ms-2" th:if="${item.itemStatus == 1}">在售</span>
                    <span class="badge bg-secondary ms-2" th:if="${item.itemStatus == 2}">下架</span>
                    <span class="badge bg-danger ms-2" th:if="${item.itemStatus == 3}">已售出</span>
                </div>

                <div class="mb-4">
                    <span class="price" th:text="'¥' + ${item.price}">¥0.00</span>
                    <span class="original-price ms-3" th:if="${item.originalPrice != null}" th:text="'原价: ¥' + ${item.originalPrice}">原价: ¥0.00</span>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">商品描述</h5>
                        <p class="card-text" th:text="${item.description}">商品描述内容</p>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">位置</small>
                                <p th:text="${item.itemLocation ?: '未指定'}">未指定</p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">联系方式</small>
                                <p th:text="${item.contactWay ?: '未提供'}">未提供</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">浏览次数</small>
                                <p th:text="${item.viewCount ?: 0}">0</p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">收藏次数</small>
                                <p th:text="${item.likeCount ?: 0}">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons (Ajax) -->
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" id="favoriteBtn" th:data-item-id="${item.id}">
                        <span id="favoriteText">收藏商品</span>
                    </button>
                    <button class="btn btn-success btn-lg" id="orderBtn" th:data-item-id="${item.id}">立即下单</button>
                    <a th:href="@{/item-edit.html(id=${item.id})}" class="btn btn-outline-secondary" th:if="${item.sellerId != null}">编辑商品</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Change main image when clicking thumbnails
        function changeMainImage(src) {
            document.getElementById('mainImage').src = src;
            document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Favorite button Ajax handler
        $('#favoriteBtn').click(function() {
            const itemId = $(this).data('item-id');
            $.ajax({
                url: '/api/favorites',
                method: 'POST',
                data: { itemId: itemId },
                success: function(response) {
                    if (response.success) {
                        alert('收藏成功！');
                        $('#favoriteText').text('已收藏');
                        $('#favoriteBtn').prop('disabled', true);
                    } else {
                        alert('收藏失败: ' + response.message);
                    }
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        alert('请先登录');
                        window.location.href = '/login.html';
                    } else {
                        alert('操作失败，请稍后重试');
                    }
                }
            });
        });

        // Order button Ajax handler
        // Note: This is a simplified implementation. In production, this should call a backend API
        // to create an actual order record and handle the transaction properly.
        $('#orderBtn').click(function() {
            const itemId = $(this).data('item-id');
            if (confirm('确认要下单购买此商品吗？')) {
                // TODO: Call backend API to create order
                // $.ajax({ url: '/api/orders', method: 'POST', data: { itemId: itemId }, ... });
                alert('下单成功！卖家将与您联系。');
            }
        });
    </script>
</body>
</html>
