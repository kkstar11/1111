# 管理员后台功能说明

## 概述
本次更新实现了管理员后台功能，包括用户账号管理和商品审核两大核心功能模块。

## 功能详情

### 1. 用户账号管理
管理员可以查看所有用户并进行启用/禁用操作。

#### 用户状态说明
- **1 (正常)**: 用户可以正常登录和使用系统
- **0 (禁用)**: 用户无法登录，已登录的会话在下次验证时失效

#### API接口
- **GET /api/admin/users** - 获取所有用户列表
  - 返回用户ID、用户名、学号、邮箱、角色、状态等信息
  
- **PUT /api/admin/users/{id}/status** - 更新用户状态
  - 请求体: `{"status": 0}` (禁用) 或 `{"status": 1}` (启用)
  - 返回: 操作成功或失败的提示

### 2. 商品审核管理
管理员可以查看待审核商品并进行通过/驳回操作。

#### 商品状态说明
- **0 (待审核)**: 新发布的商品，需要管理员审核
- **1 (上架/已通过)**: 审核通过，在商品列表中显示
- **2 (下架)**: 卖家主动下架
- **3 (已售出)**: 商品已售出
- **4 (审核驳回)**: 管理员审核不通过

#### 审核流程
1. 用户发布商品时，状态自动设为 0 (待审核)
2. 管理员在后台看到待审核商品列表
3. 管理员可以选择"通过"（状态改为1）或"驳回"（状态改为4）

#### API接口
- **GET /api/admin/items/pending** - 获取待审核商品列表
  - 返回状态为0的所有商品
  
- **PUT /api/admin/items/{id}/approve** - 审核通过商品
  - 将商品状态更新为1（上架）
  
- **PUT /api/admin/items/{id}/reject** - 驳回商品
  - 将商品状态更新为4（驳回）

## 权限控制

### 管理员角色
在 `student_user` 表中，`role` 字段标识用户角色：
- **0**: 普通用户
- **1**: 管理员

所有管理员相关的API接口都会检查用户的角色：
```java
if (!isAdmin(userDetails)) {
    return Result.failure("unauthorized: admin only");
}
```

### 访问方式
1. 登录系统
2. 访问个人中心 (/user-center.html)
3. 如果是管理员用户，会看到"管理后台"入口
4. 点击进入管理后台 (/admin.html)

## 数据库变更

### 新增字段说明
无新增字段，仅更新了 `item` 表 `status` 字段的注释以反映新的状态值。

### 运行迁移脚本
```sql
-- 更新 item 表的 status 字段注释
ALTER TABLE item MODIFY COLUMN status INT COMMENT '商品状态: 0-待审核, 1-上架, 2-下架, 3-已售出, 4-审核驳回';
```

## 前端页面

### /admin.html - 管理后台页面
包含两个主要模块：

#### 用户管理模块
- 显示所有用户的基本信息
- 显示用户当前状态（正常/禁用）
- 提供"启用"和"禁用"按钮
- 点击按钮后即时更新，并刷新列表

#### 商品审核模块
- 显示所有待审核商品
- 显示商品基本信息（名称、价格、分类等）
- 提供"通过"和"驳回"按钮
- 操作后从待审核列表中移除

## 文件清单

### 后端文件
1. **AdminController.java** - 管理员控制器
   - 处理用户管理和商品审核的所有API请求
   - 实现管理员权限检查

2. **UserMapper.java/xml** - 新增用户状态更新方法
   - `updateStatus(Long id, Integer status)`

3. **ItemMapper.java/xml** - 新增商品状态查询方法
   - `findByStatus(Integer status)`

4. **ItemServiceImpl.java** - 更新商品状态常量
   - 新增 STATUS_PENDING = 0
   - 新增 STATUS_REJECTED = 4
   - 修改商品创建逻辑，初始状态设为待审核

5. **UserServiceImpl.java** - 完善UserVO映射
   - 添加 role 和 status 字段映射

6. **ViewController.java** - 新增管理后台路由
   - `/admin.html` 路由，包含管理员权限检查

### 前端文件
1. **admin.html** - 管理后台页面
   - 用户管理界面
   - 商品审核界面
   - 实时数据加载和更新

2. **user-center.html** - 更新个人中心
   - 为管理员添加"管理后台"入口卡片

### 数据库文件
1. **migration_admin_audit.sql** - 数据库迁移脚本
   - 更新 item 表 status 字段注释

## 使用说明

### 设置管理员账号
需要在数据库中手动将用户的 `role` 字段设为 1：
```sql
UPDATE student_user SET role = 1 WHERE username = 'admin_username';
```

### 测试流程
1. 创建或指定一个管理员账号（role=1）
2. 使用普通用户账号发布商品（会自动设为待审核状态）
3. 使用管理员账号登录
4. 访问管理后台
5. 在"待审核商品管理"中可以看到刚发布的商品
6. 点击"通过"或"驳回"进行审核
7. 在"用户账号管理"中可以禁用或启用任意用户

## 注意事项

1. **权限安全**: 所有管理员API都有权限检查，非管理员无法访问
2. **状态变更**: 新发布的商品默认为"待审核"状态，只有审核通过后才会在首页显示
3. **用户禁用**: 禁用用户后，该用户无法登录，但已有的数据不会被删除
4. **数据一致性**: 建议在部署前运行迁移脚本，确保数据库字段注释与代码逻辑一致

## 未来扩展

可以考虑的增强功能：
1. 审核历史记录
2. 驳回原因说明
3. 批量操作
4. 审核通知（邮件/站内信）
5. 审核统计报表
6. 管理员操作日志
